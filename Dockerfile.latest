FROM ghcr.io/open-webui/open-webui:v0.6.15

# Install any additional dependencies if needed
USER root

# Copy our custom backend files
COPY backend/open_webui/routers/auths.py /app/backend/open_webui/routers/auths.py
COPY backend/open_webui/demo_auth_data.py /app/backend/open_webui/demo_auth_data.py
COPY backend/open_webui/utils/auth.py /app/backend/open_webui/utils/auth.py
COPY backend/open_webui/config.py /app/backend/open_webui/config.py
COPY backend/open_webui/main.py /app/backend/open_webui/main.py

# Copy our frontend patches
COPY src/routes/(app)/+layout.svelte /tmp/layout.svelte
COPY src/lib/utils/demo.js /tmp/demo.js

# Create the demo.js file if it doesn't exist in our source
RUN mkdir -p /app/src/lib/utils/ && \
    if [ -f /tmp/demo.js ]; then \
        cp /tmp/demo.js /app/src/lib/utils/demo.js; \
    else \
        echo "export function checkDemoRestriction() { return false; }" > /app/src/lib/utils/demo.js; \
    fi

# Add our runtime patches to remove anonymous content
RUN cat > /app/build/remove-anonymous.js << 'EOF'
// Remove anonymous showcase
(function() {
    console.log('EagleGPT: Removing anonymous content');
    
    function removeAnonymous() {
        // Remove any anonymous showcase elements
        document.querySelectorAll('[class*="showcase"], [class*="anonymous"], [class*="thread"], [class*="accordion"]').forEach(el => {
            if (el.textContent && (
                el.textContent.includes('Sign In to Chat') ||
                el.textContent.includes('preview mode') ||
                el.textContent.includes('Popular Threads') ||
                el.textContent.includes('Welcome to eagleGPT')
            )) {
                el.style.display = 'none';
            }
        });
        
        // Remove preview banners
        document.querySelectorAll('.bg-blue-600.text-white').forEach(el => {
            if (el.textContent.includes('preview') || el.textContent.includes('Welcome')) {
                el.remove();
            }
        });
    }
    
    // Run immediately and on DOM changes
    removeAnonymous();
    const observer = new MutationObserver(removeAnonymous);
    observer.observe(document.body, { childList: true, subtree: true });
})();
EOF

# Add demo initialization script
RUN cat > /app/build/demo-init.js << 'EOF'
// Demo mode initialization
(function() {
    const checkAuth = setInterval(function() {
        if (window.user && window.user.subscribe && window.config) {
            window.user.subscribe(function(userData) {
                if (!userData && window.config.enable_demo_mode) {
                    fetch('/api/v1/auths/demo', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'}
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.token) {
                            localStorage.setItem('token', data.token);
                            window.location.reload();
                        }
                    })
                    .catch(err => console.error('Demo auth failed:', err));
                }
            });
            clearInterval(checkAuth);
        }
    }, 100);
})();
EOF

# Inject our scripts into index.html
RUN if [ -f /app/build/index.html ]; then \
        sed -i '/<\/body>/i <script src="/remove-anonymous.js"></script>' /app/build/index.html && \
        sed -i '/<\/body>/i <script src="/demo-init.js"></script>' /app/build/index.html; \
    fi

# Set proper permissions
RUN chown -R 1000:1000 /app/backend/open_webui/*.py

# Switch back to non-root user
USER 1000

# Set environment variables
ENV ENABLE_DEMO_MODE=true
ENV WEBUI_NAME=eagleGPT
ENV WEBUI_URL=https://eaglegpt.us